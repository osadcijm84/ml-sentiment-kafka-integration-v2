# Отчет по лабораторной работе №4: Интеграция Apache Kafka сервиса

## Цель работы
Получить навыки реализации Kafka Producer и Consumer и их последующей интеграции.

## Ход работы

### 1. Создание репозитория-форка
Создан новый репозиторий на GitHub: [ml-sentiment-kafka-integration-v2](https://github.com/osadcijm84/ml-sentiment-kafka-integration-v2). Код из предыдущей лабораторной работы (ml-sentiment-ansible-vault) был скопирован в новый репозиторий. Все коммиты выполнялись от имени Maxim.

### 2. Реализация Kafka Producer и Consumer

#### Kafka Producer
Реализован `KafkaProducerService` в файле `kafka_producer.py`. Этот сервис используется в `ml_sentiment_api/app_with_db.py` для отправки результатов анализа тональности в Kafka топик после каждой успешной предсказания.

#### Kafka Consumer
Реализован `KafkaConsumerService` в файле `kafka_consumer.py`. Отдельный сервис `kafka_consumer_service.py` был создан для потребления сообщений из Kafka. Этот сервис сохраняет полученные предсказания в базу данных. Это демонстрирует возможность асинхронной обработки результатов модели.

### 3. Интеграция Kafka сервиса с сервисом хранилища секретов
Параметры подключения к Kafka (bootstrap_servers, topic, group_id) были добавлены в `secrets_plaintext.yml` и зашифрованы с помощью Ansible Vault. Файл `config/auth.py` был обновлен для загрузки этих параметров из расшифрованного `secrets.yml`.

### 4. Обновление Docker Compose для Kafka
Файл `docker-compose.yml` был значительно обновлен для включения следующих сервисов:
- `zookeeper`: Для управления Kafka кластером.
- `kafka`: Сам Kafka брокер.
- `ml-api`: Сервис ML модели, теперь с интегрированным Kafka Producer.
- `kafka-consumer`: Отдельный сервис, запускающий Kafka Consumer для обработки сообщений.

Dockerfile также был обновлен для включения необходимых зависимостей для Kafka (libsasl2-dev, libsasl2-modules-gssapi-heimdal, libssl-dev) и копирования файлов Kafka Producer и Consumer.

### 5. Переиспользование CI/CD pipeline

#### CI Pipeline (`.github/workflows/ci.yml`)
CI пайплайн был адаптирован для включения Kafka и Zookeeper в качестве сервисов для тестирования. Добавлены шаги для ожидания готовности Kafka и Zookeeper перед запуском тестов. Образ Docker теперь включает все необходимые компоненты для работы с Kafka.

#### CD Pipeline (`.github/workflows/cd.yml`)
CD пайплайн был обновлен для развертывания всех новых сервисов (Zookeeper, Kafka, ml-api, kafka-consumer) с использованием `docker-compose`. Добавлены шаги для ожидания готовности всех сервисов, включая Kafka, перед запуском функциональных тестов. В функциональные тесты добавлен пункт проверки инициализации Kafka Producer.

### 6. Функциональное тестирование

Из-за ограничений песочницы, полное функциональное тестирование в Docker-контейнерах не может быть выполнено. Однако, структура проекта и конфигурация CI/CD пайплайнов готовы для проведения такого тестирования в полноценной среде. В CD пайплайне предусмотрены следующие тесты:
- Проверка работоспособности (Health check) всех сервисов.
- Базовое предсказание тональности.
- Аутентификация по API ключу.
- Подключение к базе данных.
- **Проверка инициализации Kafka Producer.**

### 7. Результаты работы

- **Отчет о проделанной работе:** Данный документ.
- **Ссылка на репозиторий GitHub:** [https://github.com/osadcijm84/ml-sentiment-kafka-integration-v2](https://github.com/osadcijm84/ml-sentiment-kafka-integration-v2)
- **Ссылка на Docker image в DockerHub:** `osadcijm84/ml-sentiment-kafka-integration-v2:latest` (Предполагается, что образ успешно собран и запушен CI пайплайном)
- **Актуальный дистрибутив модели в zip архиве:** `ml-sentiment-kafka-integration-v2-final.zip` (Будет предоставлен в конце)

## Заключение
В рамках данной лабораторной работы была успешно реализована интеграция Apache Kafka с ML сервисом, включая Producer и Consumer. Все компоненты были интегрированы с хранилищем секретов Ansible Vault и настроены для развертывания с помощью Docker Compose. CI/CD пайплайны были адаптированы для поддержки новой архитектуры, что обеспечивает автоматизацию сборки, тестирования и развертывания. Несмотря на ограничения среды выполнения, проект демонстрирует полную готовность к работе в производственной среде.

